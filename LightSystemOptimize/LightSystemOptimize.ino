#include <avr/pgmspace.h>

// Define Master Relay
struct MasterRelay {
  uint8_t relayNumber;
  uint8_t pin;
  bool state;
};

// Define Slave Relay
struct SlaveRelay {
  uint8_t relayNumber;
  bool state;
};

// Define Phase (moved to PROGMEM-compatible structure)
struct Phase {
  uint16_t duration;
  uint8_t activeRelays[27];  // Relay numbers that should be ON
  uint8_t numRelays;
};

// Master Relay list (stored in flash)
const MasterRelay masterRelays[] PROGMEM = {
  {1, 2, false},  {2, 3, false},  {3, 4, false},  {4, 5, false},
  {5, 6, false},  {6, 7, false},  {7, 8, false},  {8, 9, false},
  {9, 10, false}, {10, 11, false}, {11, 12, false}, {12, 13, false},
  {13, A0, false},
};
const uint8_t numMasterRelays = sizeof(masterRelays) / sizeof(MasterRelay);

// Slave Relay list (stored in flash)
const SlaveRelay slaveRelays[] PROGMEM = {
  {14, false}, {15, false}, {16, false}, {17, false}, {18, false},
  {19, false}, {20, false}, {21, false}, {22, false}, {23, false},
  {24, false}, {25, false}, {26, false}, {27, false}
};
const uint8_t numSlaveRelays = sizeof(slaveRelays) / sizeof(SlaveRelay);

// Sample Phase list (replace/add full list in same format)
const Phase phases[] PROGMEM = {
  {1000, {1, 5,6,7,8,12,13 , 14,18,19,23,24,25,26},14},          // Phase 1 - 30s
  {1000, {2, 5,6,7,9,12,13, 14,18,20,23,24,25,26},14},
  {1000, {3, 5,6,7,10,12,13, 15,18,21,23,24,25,26},14},
  {1000, {4, 5,6,7,11,12,13, 16,18,22,23,24,25,26},14},//4colour ruun
  {200,  {1, 5, 8,12,13, 14,18, 19,23,24,25,26,27},14,}, //com.5.6.7. run
   {200, {1, 6, 8,12,13, 14,18, 19,23,24,25,26,27},14}, 
   {200, {1, 7, 8,12,13, 14,18, 19,23,24,25,26,27},14}, 
   {200, {1, 5, 9,12,13, 15,18, 20,23,24,25,26,27},14}, 
   {200, {1, 6, 9,12,13, 15,18, 20,23,24,25,26,27},14}, 
   {200, {1, 7, 9,12,13, 15,18, 20,23,24,25,26,27},14}, 
   {200, {2, 5, 10,13,  16,18,  21,23,24,25,26,27},14}, 
   {200, {2, 6, 10,      16,18, 21,23,24,25,26,27},14}, 
   {200, {2, 7, 11,12,13, 16,18, 21,23,24,25,26,27},14}, 
   {200, {2, 5, 11,12,13, 17,18 ,22,23,24,25,26},14}, 
   {200, {2, 6, 8,9,13,   17,18 ,22,23,24,25,26},14}, 
   {200, {2, 7, 8,9,12,13, 17,18, 22,23,24,25,26},14},
    {200,{3, 5, 9,10,12,13 ,16,14,18, 19,20,23,24,25,26},14}, 
   {200, {3, 6, 9,10,12,13, 16,14,18, 19,20,24,25,26},14}, 
   {200, {3, 7, 9,10,12,13, 15,16,18, 19,20,24,25,26},14}, 
   {200, {3, 5, 9,10,12,13, 15,16,18, 20,21,24,25,26},14}, 
   {200, {3, 6, 8,10,12,13, 15,16,18, 20,21,24,25,26},14}, 
   {200, {3, 7, 8,10,12,13, 14,16,18 ,20,21,24,25,26},14},
  {200,  {4, 7, 11,12,13, 14,16,18, 19,21,24,25,26},14}, 
   {200, {4, 5, 11,12,13, 14,16,18, 19,21,24,25,26},14}, 
   {200, {4, 6, 11,12,13, 14,16,18, 19,21,24,25,26},14}, 
   {200, {4, 7, 12,8,13, 16,18, 20,21,23,24,25,26},14},
  {200,  {4, 7, 11,8,12,13, 16,18, 20,23,24,25,26},14}, 
   {200, {4, 5, 11,8,12,13, 16,18, 21,23,24,25,26},14},
   {250,  {1,3, 5, 6,17,11,8,12,13,17,18,22,24,25,26,},14,},//vio flash
{250,  {2, 8,},14,},
{275,  {1,3, 5,6,7,11 ,8,12,13,17,18,22,23,24,25,26,},14},//vio flash
{250,  {2, 8,},14,},
{275,  {1,3, 5,6,7,11 ,8,12,13,17,18,22,23,24,25,26,},14},
{200, {1,2, 5, 8,12,13, 17,18, 19,25,26,27},14}, 
{200, {1,2, 6, 8,12,13, 16,18, 19,24,26,27},14}, 
{200, {1,2, 7, 8,12,13, 15,18, 19,23,26,27},14}, 
{200, {1,2, 6, 8,9,12,13, 14,18, 19,25,26,27},14},
{200, {1,2, 5, 8,9,12,13, 16,18, 19,24,26,27},14}, 
{200, {1,2, 6, 8,9,12,13, 15,16, 19,23,26,27},14}, 
{200, {1,2, 7, 8,10,12,13, 14,16,18, 22,23,24,25,26,27},14}, 
{200, {1,2, 6, 8,10,12,13, 17,16,18, 22,23,24,25,26,27},14},
{200, {1,2,5,9,10,12,13, 16,18, 20,23,26,27},14}, 
{200, {2, 6, 9,10,12,13, 16,18, 20,24,26,27},14}, 
{200, {1,2,7, 9,10,12,13, 16,18, 20,25,26,27},14},
{1000, {1,2,5, 6,7, 9,13,12,15,18, 21,20,23,24,25,26,27},14},
{1000, {1,2,5, 6,7, 10,12,13,16,18, 20,19,23,24,25,26,27},14},
{1000, {1,3, 5,6,7, 8,12,13, 15,18, 21,19,24,25,26,27},14},
{1000, {1,3, 5,6,7, 9,12,13, 16,18, 22,19,23,24,25,26,27},14},
{1000, {2,3,5,6,7,8,9,12,13, 14,18, 22,23,24,25,26,27},14},
{1000, {2,3,5,6,7,10,9,12,13, 16,18, 22,23,24,25,26,27},14},
{200, {1,  5,6,7,  10,12,13, 16,18, 19,23,26,27},14}, 
{200, {1,  6,7,   11,12,13, 16,18, 20,24,26,27},14}, 
{200, {1,  5,7,  11,12,13, 16,18, 21,25,26,27},14},
{200, {1,5,6 , 11,12,13, 16,18, 22,23,24,25,26,27},14}, 
{200, {1,6,7, 11,12,13, 16,18, 22,23,24,25,26,27},14}, 
{200, {1, 5,6, 8,9,12,13, 16,18, 22,23,24,25,26,27},14},
{250,  {3, 5, 6,17,11,8,12,13,17,18, 22,24,25,26,},14,},//bl flash
{250,  {2, 8,},14,},
{275,  {3, 5,6,7,11 ,8,12,13,17,18, 22,23,24,25,26,},14},//bl flas
{800,  {1, 5,  8,9,12,13, 14,16,18, 19,21,23,24,25,26,27},14,},
{750 , {1, 6, 8,9,12,13, 14,15,18, 19,20,23,24,25,26,27},14,},
{700,  {1, 7, 8,9,12,13, 14,16,18, 19,21,23,24,25,26,27},14,},
{650,  {1, 5, 8,10,12,13, 14,16,18, 19,25,26,27},14,},
{600,  {1, 6, 8,10,12,13, 15,16,18, 19,24,26,27},14,},
{550,  {1, 7, 8,10,12,13, 15,16,18, 19,23,26,27},14,},
{500,  {1, 5, 9,10,12,13, 15,16,18, 19,21,25,26,27},14,},
{450,  {1, 6, 9,12,13, 17,18 ,19,21,24,26,27},14,},
{400,  {1, 7, 8,12,13, 17,18, 19,21,23,26,27},14,},
{350,  {1, 5, 8,12,13, 17,18, 20,21,25,26,27},14,},
{300,  {1, 6, 8,12,13, 17,18, 20,21,24,26,27},14,},
{250,  {1, 7, 8,12,13, 14,16,18, 20,21,23,24,25,26,27},14,},
{200,  {1, 5, 8,12,13, 14,16,18, 20,21,24,26,27},14,},
{150,  {1, 5,  8,12,13, 14,16,18, 20,21,25,26,27},14,},
{120 , {1, 6, 8,12,13, 16,18 ,20,21,23,26,27},14,},
{110,  {1,7,  8,12,13, 16,18, 20,21,24,25,26,27},14,},
{100, {1, 5, 8,12,13, 16,18, 20,21 ,25,26,27},14,},
{90,  {1, 6, 8,12,13, 16,18, 22,23,26,27},14,},
{87,  {2, 7, 11,12,13, 17, 18, 22,24,26,27},14,},
{88,  {2, 5, 11,12,13, 14, 18, 22,25,26,27},14,},
{90,  {2, 6, 11,12,13, 1, 18, 22,23,26,27},14,},
{95,  {2, 7, 11,13,16,    18, 22,24,26,27},14,},
{100,  {2, 5, 11,12,13, 16, 18, 22,25,26,27},14,},
{100,  {2, 5,  10,11,12,13 ,16,18, 19,21,23,26,27},14,},
{150 , {2, 6, 10,11,12,13, 16,18, 19,20,24,26,27},14,},
{200,  {2, 7, 8,12,13, 16,18, 20,21,25,26,27},14,},
{250,  {2, 5, 8,12,13, 15,18, 19,20,24,26,27},14,},
{300, {2, 6, 8,12,13, 15,18, 19,21,23,25,26,27},14,},
{350,  {2, 7, 8,12,13, 15,18, 19,20,24,26,27},14,},
{400,  {2, 5, 9,10,12,13, 15,18, 20,21,25,26,27},14,},
{550,  {2, 6, 9,10,12,13, 15,18, 19,20,24,26,27},14,},
{575,  {2, 7, 9,10,12,13, 14,18, 19,21,23,26,27},14,},
{600,  {2, 6, 8,12,13, 14,18, 19,20,24,26,27},14,},
{650,  {2, 7, 8,12,13, 14,18, 20,21,25,26,27},14,},
{50,  {4, 5, 6,17,11,8,12,13,17,18,22,24,25,26,},14,},//white flash
{50,  {2, 8,},14,},
{75,  {4, 5,6,7,11 ,8,12,13,17,18,22,23,24,25,26,},14},//white flash
{50,  {2, 8,},14,},
{75,  {4, 5,6,7,11 ,8,12,13,17,18,22,23,24,25,26,},14},
{50,  {2, 8,},14,},//white flash
{75,  {4, 5,6,7,11 ,8,12,13,17,18,22,23,24,25,26,},14},//white flash
{50,  {2, 8,},14,},
{50,  {2, 8,},14,},//white flash
{75,  {4, 5,6,7,11 ,8,12,13,17,18,22,23,24,25,26,},14},//white flash
{50,  {2, 8,},14,},
{75,  {4, 5,6,7,11 ,8,12,13,17,18,22,23,24,25,26,},14},//white flash
{1500,  {4,11 ,8,17,22,},14},//all off
{1000,  {26,14,},14},//start red
{1000, {19,14,22,23,24,25,26},14},//second red
{1000,  {14,18,19,22,23,24,25,26},14},//3rd red
{1000,  {8,12,13,14,18,19,22,23,24,25,26},14},//4th red
{1000,  {1,5,6,7,8,12,13,14,18,19,22,23,24,25,26},14},
{150,  {9,12,13,15,18,20,22,23,24,25,26},14},//green
{150,  {15,18,20,22,23,24,25,26},14},
{150, {20,14,22,23,24,25,26},15},
{150,  {26,14,},15},
{150,  {26,16,},15},
{150, {19,21,14,16,18,23,24,25,26},14},//second red
{150,  {15,14,18,19,20,22,23,24,25,26},14},//3rd red
{150,  {9,8,12,13,15,18,20,22,23,24,25,26},14},//4th red
{150,  {1,2,5,6,7,9,12,13,15,18,20,22,23,24,25,26},14},
{150,  {9,12,13,15,18,20,22,23,24,25,26},14},
{150,  {15,18,20,22,23,24,25,26},14},
{150, {20,14,22,23,24,25,26},15},
{150,  {26,14,},15},
{50,  {15,16,26,},14,},//white flash
{75,  {23,24,25,19,21 ,},14},//white flash
{50,  {14,15,18,},14,},
{75,  {9,10,12,13},14},
{75,  {5,6,7,1,3,4},14}
};
const uint16_t numPhases = sizeof(phases) / sizeof(Phase);

// RAM objects for working
MasterRelay masterCopy[numMasterRelays];
SlaveRelay slaveCopy[numSlaveRelays];
Phase currentPhase;
uint16_t currentPhaseIndex = 0;
unsigned long phaseStartTime = 0;

void loadPhaseFromPROGMEM(uint16_t index) {
  memcpy_P(&currentPhase, &phases[index], sizeof(Phase));
}

void loadRelaysFromPROGMEM() {
  memcpy_P(masterCopy, masterRelays, sizeof(masterRelays));
  memcpy_P(slaveCopy, slaveRelays, sizeof(slaveRelays));
}

void applyPhase(const Phase &p) {
  // Turn all master relays OFF
  for (uint8_t i = 0; i < numMasterRelays; i++) {
    digitalWrite(masterCopy[i].pin, LOW);
    masterCopy[i].state = false;
  }

  // Turn ON selected master relays
  for (uint8_t i = 0; i < p.numRelays; i++) {
    uint8_t relayNum = p.activeRelays[i];
    for (uint8_t j = 0; j < numMasterRelays; j++) {
      if (masterCopy[j].relayNumber == relayNum) {
        digitalWrite(masterCopy[j].pin, HIGH);
        masterCopy[j].state = true;
        break;
      }
    }
  }

  // Send to slaves
  sendSlavePhaseCommand(p);
}

void sendSlavePhaseCommand(const Phase &p) {
  Serial.print("U"); // Update command
  for (uint8_t i = 0; i < numSlaveRelays; i++) {
    bool shouldBeOn = false;
    for (uint8_t j = 0; j < p.numRelays; j++) {
      if (slaveCopy[i].relayNumber == p.activeRelays[j]) {
        shouldBeOn = true;
        break;
      }
    }
    slaveCopy[i].state = shouldBeOn;
    Serial.print(",");
    Serial.print(slaveCopy[i].relayNumber);
    Serial.print(":");
    Serial.print(shouldBeOn ? 1 : 0);
  }
  Serial.println();
}

void setup() {
  Serial.begin(9600);
  loadRelaysFromPROGMEM();

  for (uint8_t i = 0; i < numMasterRelays; i++) {
    pinMode(masterCopy[i].pin, OUTPUT);
    digitalWrite(masterCopy[i].pin, LOW);
  }

  delay(1000);
  loadPhaseFromPROGMEM(currentPhaseIndex);
  applyPhase(currentPhase);
  phaseStartTime = millis();
}

void loop() {
  if (millis() - phaseStartTime >= currentPhase.duration) {
    currentPhaseIndex = (currentPhaseIndex + 1) % numPhases;
    loadPhaseFromPROGMEM(currentPhaseIndex);
    applyPhase(currentPhase);
    phaseStartTime = millis();
  }
} //
